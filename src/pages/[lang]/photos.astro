---
import BaseLayout from '@layouts/BaseLayout.astro';
import { useTranslations, type Lang } from '@i18n/ui';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  return [
    { params: { lang: 'en' } },
    { params: { lang: 'zh' } },
  ];
}

const { lang } = Astro.params as { lang: Lang };
const t = useTranslations(lang);

let photoAlbums: any[] = [];
try {
  photoAlbums = await getCollection('photos', ({ data }) => {
    return data.lang === lang;
  });
  photoAlbums.sort((a, b) => {
    const dateA = new Date(a.data.date).getTime();
    const dateB = new Date(b.data.date).getTime();
    return dateB - dateA;
  });
} catch (e) {
  // Collection might not exist yet
}

const title = lang === 'en' ? 'Photos - Research Lab' : '相册 - 研究实验室';
const description = lang === 'en' 
  ? 'Photo gallery'
  : '相册';
---

<BaseLayout lang={lang} title={title} description={description} currentPath={`/${lang}/photos/`}>
  <div class="container">
    <h1 class="section-title">{t('photos.title')}</h1>
    
    {photoAlbums.length === 0 ? (
      <p>{lang === 'en' ? 'No photos yet.' : '暂无照片。'}</p>
    ) : (
      <div class="photos-grid">
        {photoAlbums.map((album) => (
          <article class="card photo-album">
            <h3>{album.data.title}</h3>
            <span class="card-date">
              {new Date(album.data.date).toLocaleDateString(lang === 'en' ? 'en-US' : 'zh-CN')}
            </span>
            {album.data.description && <p>{album.data.description}</p>}
            {album.data.images && album.data.images.length > 0 && (
              <div class="photo-thumbnails">
                {album.data.images.slice(0, 4).map((img: string) => (
                  <img src={img} alt={album.data.title} class="photo-thumb" loading="lazy" />
                ))}
                {album.data.images.length > 4 && (
                  <div class="photo-more">+{album.data.images.length - 4}</div>
                )}
              </div>
            )}
          </article>
        ))}
      </div>
    )}
  </div>
</BaseLayout>

<style>
  .photos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
  }
  
  .photo-album {
    margin-bottom: 0;
  }
  
  .photo-thumbnails {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    margin-top: 1rem;
    position: relative;
  }
  
  .photo-thumb {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s ease;
  }
  
  .photo-thumb:hover {
    transform: scale(1.05);
  }
  
  .photo-more {
    position: absolute;
    bottom: 0.5rem;
    right: 0.5rem;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    font-weight: 600;
  }
  
  @media (max-width: 768px) {
    .photos-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

